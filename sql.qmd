---
title: "SQL and Database"
---

# Instructions

The top 18 columns show a simplistic overview of 3 tables we have at Overstock.com. Your task will be to write SQL as if you were querying these tables to retrieve the data as specified in the questions.

The questions will require you to join tables and make calculations within the SQL to get the desired output.

Please note column E (notes) to verify you are using columns and data correctly as you write the SQL.

## Database Metadata

```{r}
#| echo: false

df <- read.csv("data/database-metadata.csv", check.names = F)
# knitr::kable(df)
kableExtra::kbl(df) |>
  kableExtra::kable_styling(font_size = 12)
```

# Questions

## Question 1

Show me sale revenue (top line & bottom line) by Marketing channel for the past 90 days trended by day.

## Answer 1

```{r}
#| echo: false
#| warning: false
#| output: false
library(tidyverse)
library(DBI)
library(RSQLite)
library(dbplyr)

BI_VISIT <- read.csv("data/bi-visit.csv", check.names = F)
BI_SALES <- read.csv("data/bi-sales.csv", check.names = F)
BI_CAMPAIGN_DESCRIPTION <- read.csv("data/bi-campaign-description.csv", check.names = F)

con <- DBI::dbConnect(RSQLite::SQLite(), 
                      dbname = ":memory:")
copy_to(dest = con, 
        df = BI_VISIT, 
        name = "BI_VISIT")

copy_to(dest = con, 
        df = BI_SALES, 
        name = "BI_SALES")

copy_to(dest = con, 
        df = BI_CAMPAIGN_DESCRIPTION, 
        name = "BI_CAMPAIGN_DESCRIPTION")

# dbListTables(con)
```

```{sql max.print = 10}
#| connection: con
WITH sales_data AS (
  SELECT SALES_TRANSACTION_DATE AS "DAY"
    , CHANNEL_DESCRIPTION AS "CHANNEL"
    , SUM(REVENUE_TOP_LINE) AS "TOP_LINE"
    , LEAD(SUM(REVENUE_TOP_LINE), 1) 
      OVER(
        PARTITION BY CHANNEL_DESCRIPTION 
        ORDER BY SALES_TRANSACTION_DATE DESC
      ) AS "TOP_LAG"
    , SUM(REVENUE_BOTTOM_LINE) AS "BOTTOM_LINE"
    , LEAD(SUM(REVENUE_BOTTOM_LINE), 1) 
      OVER(
        PARTITION BY CHANNEL_DESCRIPTION 
        ORDER BY SALES_TRANSACTION_DATE DESC
      ) AS "BOTTOM_LAG"
  FROM BI_SALES
  LEFT JOIN BI_CAMPAIGN_DESCRIPTION
  ON SALES_TRANSACTION_CAMPAIGN_ID = CAMPAIGN_ID
  WHERE SALES_TRANSACTION_DATE >= DATETIME('now', '-90 day')
  GROUP BY SALES_TRANSACTION_DATE, CHANNEL_DESCRIPTION
  ORDER BY SALES_TRANSACTION_DATE DESC
)

SELECT DAY
  , CHANNEL
  , TOP_LINE
  , (TOP_LINE - TOP_LAG) / TOP_LAG * 100 AS "% DAILY TOP LINE TREND"
  , BOTTOM_LINE
  , (BOTTOM_LINE - BOTTOM_LAG) / BOTTOM_LAG AS "% DAILY BOTTOM LINE TREND"
FROM sales_data;
```

## Question 2

Show me the number of visits, visitors and bounce rate for each Marketing Channel for the past 90 days trended by day. (Hint: Bounce rate = Single page view visits / total visits)

## Answer 2

```{sql max.print = 20}
#| connection: con
with visits_data AS (
  SELECT VISIT_DT AS "DAY"
    , CHANNEL_DESCRIPTION AS "CHANNEL"
    , COUNT(DISTINCT VISIT_ID) AS "VISITS"
    , LEAD(COUNT(DISTINCT VISIT_ID), 1) 
      OVER(
        PARTITION BY CHANNEL_DESCRIPTION 
        ORDER BY VISIT_DT DESC
      ) AS "VISITS_LAG"
    , COUNT(DISTINCT VISITOR_ID) AS "VISITORS"
    , LEAD(COUNT(DISTINCT VISITOR_ID), 1) 
      OVER(
        PARTITION BY CHANNEL_DESCRIPTION 
        ORDER BY VISIT_DT DESC
      ) AS "VISITORS_LAG"
    , SUM(
      CASE
        WHEN PAGE_VIEW_COUNT = 1 THEN 1
        ELSE 0
      END) AS "BOUNCES"
    , LEAD(
      SUM(
        CASE
          WHEN PAGE_VIEW_COUNT = 1 THEN 1
          ELSE 0
        END), 1) 
      OVER(
        PARTITION BY CHANNEL_DESCRIPTION
        ORDER BY VISIT_DT DESC
      ) AS "BOUNCE_LAG"
  FROM BI_VISIT
  LEFT JOIN BI_CAMPAIGN_DESCRIPTION
  ON FIRST_PAGE_VIEW_CAMPAIGN_ID = CAMPAIGN_ID
  WHERE VISIT_DT >= DATETIME('now', '-90 day')
  GROUP BY VISIT_DT, CHANNEL_DESCRIPTION
  ORDER BY VISIT_DT DESC
)

SELECT DAY
  , CHANNEL
  , VISITS
  , (VISITS - VISITS_LAG) / VISITS_LAG * 100 AS "% DAILY VISITS TREND"
  , VISITORS
  , (VISITORS - VISITORS_LAG) / VISITORS_LAG * 100 AS "% DAILY VISITORS TREND"
  , BOUNCES / VISITS AS "BOUNCE RATE"
  , ((BOUNCES / VISITS) - (BOUNCE_LAG / VISITS_LAG)) / (BOUNCE_LAG / VISITS_LAG) AS "% DAILY BOUNCE RATE TREND"
FROM visits_data
```

## Question 3

Show me the number of visits each Marketing channel acquired and the revenue (top line & Bottom line) for each last clicked Marketing channel for the past 90 days trended by day. Calculate conversion rate (orders/visits). Answer in one query.

## Answer 3

```{sql max.print = 10}
#| connection: con
WITH sales_data AS (
  SELECT SALES_TRANSACTION_DATE AS "DAY"
    , CHANNEL_DESCRIPTION AS "CHANNEL"
    , SUM(REVENUE_TOP_LINE) AS "TOP_LINE"
    , LEAD(SUM(REVENUE_TOP_LINE), 1) 
      OVER(
        PARTITION BY CHANNEL_DESCRIPTION 
        ORDER BY SALES_TRANSACTION_DATE DESC
      ) AS "TOP_LAG"
    , SUM(REVENUE_BOTTOM_LINE) AS "BOTTOM_LINE"
    , LEAD(SUM(REVENUE_BOTTOM_LINE), 1) 
      OVER(
        PARTITION BY CHANNEL_DESCRIPTION 
        ORDER BY SALES_TRANSACTION_DATE DESC
      ) AS "BOTTOM_LAG"
  FROM BI_SALES
  LEFT JOIN BI_CAMPAIGN_DESCRIPTION
  ON SALES_TRANSACTION_CAMPAIGN_ID = CAMPAIGN_ID
  WHERE SALES_TRANSACTION_DATE >= DATETIME('now', '-90 day')
  GROUP BY SALES_TRANSACTION_DATE, CHANNEL_DESCRIPTION
  ORDER BY SALES_TRANSACTION_DATE DESC
)

SELECT DAY
  , CHANNEL
  , TOP_LINE
  , (TOP_LINE - TOP_LAG) / TOP_LAG * 100 AS "% DAILY TOP LINE TREND"
  , BOTTOM_LINE
  , (BOTTOM_LINE - BOTTOM_LAG) / BOTTOM_LAG AS "% DAILY BOTTOM LINE TREND"
FROM sales_data;
```
